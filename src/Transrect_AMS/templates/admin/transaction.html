<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Transaction Review</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body class="bg-light">

    <div class="container mt-5">
        <h2 class="mb-4">Transaction Inbox</h2>

        <!-- Search Form -->
        <form method="GET">
            <div class="input-group mb-3">
                <input type="text" name="search" class="form-control" placeholder="Search transactions..."
                    value="{{ search_query }}">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>

        <!-- Transaction List -->
        <div class="list-group">
            {% for transaction in transactions %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <span class="{% if not transaction.read %}fw-bold{% endif %}">
                    Order #{{ transaction.transaction_id }} - Rs {{ transaction.amount }} ({{ transaction.account }}) -
                    Location: {{ transaction.location }}
                </span>
                {% if not transaction.read %}
                <form method="POST" action="/mark_read" class="d-inline">
                    <input type="hidden" name="transaction_id" value="{{ transaction.transaction_id }}">
                    <button type="button" class="btn btn-success btn-sm mark-read-btn"
                        data-id="{{ transaction.transaction_id }}">
                        Mark as Read
                    </button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        <div class="text-center mt-3">
            {% if pagination.has_prev %}
            <a href="{{ url_for('trans', page=pagination.prev_num, search=search_query) }}"
                class="btn btn-outline-primary">Previous</a>
            {% endif %}
            Page {{ pagination.page }} of {{ pagination.pages }}
            {% if pagination.has_next %}
            <a href="{{ url_for('trans', page=pagination.next_num, search=search_query) }}"
                class="btn btn-outline-primary">Next</a>
            {% endif %}
        </div>
    </div>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".mark-read-btn").forEach(button => {
                button.addEventListener("click", function () {
                    let transactionId = this.getAttribute("data-id");

                    fetch("/mark_read", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: `transaction_id=${transactionId}`
                    }).then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload(); // Refresh to update UI
                            }
                        });
                });
            });
        });
    </script>

</body>

</html>